# NYC Subway Map LED Visualization

A real-time visualization of NYC subway train locations using an ESP32 microcontroller and WS2812B LED strips. This project creates a physical illuminated map that shows trains arriving at stations throughout the New York City subway system by lighting up LEDs at station locations when trains are present.

## Demo

[![Watch the video](https://img.youtube.com/vi/n46n9YuOSNA/maxresdefault.jpg)](https://youtube.com/shorts/n46n9YuOSNA)

---

## How It Works

The ESP32 connects to a custom [MTAPI server](MTAPI/README.md) via **WebSockets**. The server fetches real-time GTFS-RT data from the MTA, processes it, and broadcasts train arrival events. The ESP32 parses these JSON payloads and updates the LEDs to reflect train arrivals at each station, using line-specific colors.

- **WebSocket-based updates:**  
  The ESP32 maintains a persistent connection to `/ws` on the MTAPI server. Incoming messages are parsed and mapped to station LEDs in real time. This is more efficient and responsive than HTTP polling.

---

## Hardware Requirements

- ESP32 development board
- WS2812B LED strips (minimum 500 LEDs for full subway system)
- 5V power supply (≥10A recommended for full map)
- Wires and mounting materials
- Physical subway map for LED placement

---

## Software Dependencies

- [PlatformIO](https://platformio.org/) (recommended) or Arduino IDE
- Libraries:
  - [FastLED](https://github.com/FastLED/FastLED) ^3.9.7
  - [ArduinoJson](https://arduinojson.org/) ^6.21.4
  - [ArduinoWebsockets](https://github.com/gilmaimon/ArduinoWebsockets) ^0.5.4
  - [Time](https://github.com/PaulStoffregen/Time) ^1.6.1

---

## Project Structure

```
├── include/
│   ├── GeneratedStationMap.h   # Auto-generated LED-to-station mapping
│   ├── HeapDebug.h             # Heap memory debugging utilities
│   ├── LEDManager.h            # LED control logic
│   ├── MTAManager.h            # MTA data handling
│   ├── NetworkManager.h        # WiFi/WebSocket management
│   ├── Station.h               # Station data structures
│   ├── SubwayColors.h          # Subway line color definitions
│   ├── TimeManager.h           # Time utilities
│   ├── Train.h                 # Train data structures
│   └── WifiCredentials.h       # WiFi/server credentials
├── src/
│   ├── main.cpp                # Main application logic
│   ├── GeneratedStationMap.cpp # Station map definition
│   ├── LEDManager.cpp
│   ├── MTAManager.cpp
│   ├── NetworkManager.cpp
│   ├── Station.cpp
│   ├── SubwayColors.cpp
│   ├── TimeManager.cpp
│   └── Train.cpp
├── MTAPI/                      # Python server for MTA data (WebSocket support)
│   ├── app.py
│   ├── requirements.txt
│   ├── settings.cfg.sample
│   ├── mtapi.Dockerfile
│   ├── docker-compose.yml
│   └── data/
│       ├── stations.json
│       └── stations.csv
├── scripts/
│   └── generate_station_map.py # Generates station LED mapping header
├── test/                       # PlatformIO unit tests
├── platformio.ini              # PlatformIO configuration
└── README.md                   # This file
```

---

## Key Components

- [`main.cpp`](src/main.cpp): Main loop, WiFi/WebSocket setup, LED updates
- [`MTAManager.h`](include/MTAManager.h) / [`MTAManager.cpp`](src/MTAManager.cpp): Parses train arrival data, manages station/train state
- [`GeneratedStationMap.h`](include/GeneratedStationMap.h) / [`GeneratedStationMap.cpp`](src/GeneratedStationMap.cpp): Maps LED indices to station IDs (auto-generated by [`generate_station_map.py`](scripts/generate_station_map.py))
- [`WifiCredentials.h`](include/WifiCredentials.h): WiFi and server configuration
- [`LEDManager.h`](include/LEDManager.h) / [`LEDManager.cpp`](src/LEDManager.cpp): LED initialization and update logic
- [`SubwayColors.h`](include/SubwayColors.h) / [`SubwayColors.cpp`](src/SubwayColors.cpp): Subway line color mapping
- [`Train.h`](include/Train.h) / [`Train.cpp`](src/Train.cpp): Train arrival logic with 30-second arrival window
- [`Station.h`](include/Station.h) / [`Station.cpp`](src/Station.cpp): Station and train data structures
- [`TimeManager.h`](include/TimeManager.h): NTP time setup and printing
- [`NetworkManager.h`](include/NetworkManager.h) / [`NetworkManager.cpp`](src/NetworkManager.cpp): WiFi and WebSocket connection management with automatic reconnection
- [`HeapDebug.h`](include/HeapDebug.h): Memory usage monitoring utilities
- [`MTAPI`](MTAPI/README.md): Python server for real-time MTA data with WebSocket broadcasting

---

## Setup Instructions

### 1. Hardware Setup

1. Connect WS2812B LED data line to ESP32 pin 10 (D7)
2. Power ESP32 and LED strips with a 5V supply
3. Mount LEDs on your map, matching each LED to its station

### 2. WiFi Configuration

Edit [`WifiCredentials.h`](include/WifiCredentials.h):

```cpp
#ifndef WIFI_CREDENTIALS_H
#define WIFI_CREDENTIALS_H
constexpr const char* WIFI_SSID = "your_wifi_ssid";
constexpr const char* WIFI_PASSWORD = "your_wifi_password";
constexpr const char* SERVER_HOST = "your_mtapi_server_ip";
constexpr const char* SERVER_PORT = "5000";
#endif // WIFI_CREDENTIALS_H
```

### 3. MTAPI Server Setup

This project uses a modified version of MTAPI that adds WebSocket support for real-time data broadcasting:

1.  The modified MTAPI is included in this project under the MTAPI directory
2.  Create a  `settings.cfg`  file based on  `settings.cfg.sample`:
```docker
       # MTA_KEY = 'your_mta_api_key' #deprecated
       STATIONS_FILE = 'data/stations.json'
       CACHE_SECONDS = 60
       MAX_TRAINS = 10
       MAX_MINUTES = 30
       THREADED = True
```

3. Install Python dependencies:
```bash
cd MTAPI
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

4. Run the server:
```bash
python app.py
```

Alternatively, use Docker with the provided [`mtapi.Dockerfile`](MTAPI/mtapi.Dockerfile):
```bash
docker-compose up
```

### 4. ESP32 Firmware Installation

**PlatformIO (recommended):**
1. Open project in PlatformIO
2. Build configuration is in [`platformio.ini`](platformio.ini)
3. Build and upload to ESP32: `pio run -t upload`

**Arduino IDE:**
1. Install required libraries (FastLED, ArduinoJson, ArduinoWebsockets, Time)
2. Open [`main.cpp`](src/main.cpp) as sketch
3. Select "Arduino Nano ESP32" board
4. Upload

---

## Station Mapping

- [`GeneratedStationMap.h`](include/GeneratedStationMap.h) declares the station map
- [`GeneratedStationMap.cpp`](src/GeneratedStationMap.cpp) defines the actual mapping (auto-generated)
- Use [`generate_station_map.py`](scripts/generate_station_map.py) to regenerate the mapping from [`stations.csv`](MTAPI/data/stations.csv)
- Ensure LED indices match the physical order of your installation

**To regenerate station map:**
```bash
cd scripts
python generate_station_map.py
```

---

## How the Code Works

### Real-Time Updates via WebSockets

- ESP32 connects to MTAPI server (`ws://<SERVER_HOST>:<SERVER_PORT>/ws`)
- Server pushes JSON train arrival data containing station updates
- [`NetworkManager`](include/NetworkManager.h) handles connection and message parsing with automatic reconnection
- [`MTAManager`](include/MTAManager.h) updates station/train state and triggers LED updates
- [`LEDManager`](include/LEDManager.h) sets LED colors based on train arrivals and line colors from [`SubwayColors`](include/SubwayColors.h)

**Example main loop from [`main.cpp`](src/main.cpp):**
```cpp
void loop() {
  net.poll(); 
  
  if (net.checkWifiConnection())
    net.checkWebsocketConnection();

  MtaManager::purgeExpiredTrains();
  MtaManager::checkArrivals();

  if (!MtaManager::hasAnyTrainData())
    LEDManager::awaitingDataSequence();

  LEDManager::show();
  EVERY_N_SECONDS(1) { digitalWrite(LED_BUILTIN, !digitalRead(LED_BUILTIN)); }
  EVERY_N_SECONDS(60) { TimeManager::printCurrentTime(); }

#ifdef HEAPDEBUG
  EVERY_N_SECONDS(30) { HeapDebug::printHeapUsage(); }
#endif
}
```

### Train Arrival Logic

- Trains are considered "at station" for 30 seconds after their scheduled arrival (see [`Train.cpp`](src/Train.cpp))
- Multiple trains can be present at a station simultaneously
- Expired trains are automatically purged by [`MtaManager::purgeExpiredTrains()`](src/MTAManager.cpp)

### Startup Sequence

- LEDs alternate even/odd with warm white until first train data arrives (system ready indicator)
- See [`LEDManager::awaitingDataSequence()`](src/LEDManager.cpp)

### Error Handling

- WiFi connection monitoring with exponential backoff (max 30 seconds)
- WebSocket automatic reconnection with ping/pong keepalive
- See [`NetworkManager`](src/NetworkManager.cpp) for implementation details

---

## Troubleshooting

### LED Issues

- **No LEDs light up:** Check power supply and data pin connections (GPIO 10/D7)
- **Random flickering:** Power supply may be insufficient (≥10A for 500 LEDs recommended)
- **Wrong stations light up:** Verify [`GeneratedStationMap.cpp`](src/GeneratedStationMap.cpp) matches your physical layout

### Connectivity Issues

- **No data received:** Ensure MTAPI server is running and accessible from ESP32
- **Frequent disconnections:** Check WiFi signal strength and server stability
- **WebSocket errors:** Verify server is running on correct host/port in [`WifiCredentials.h`](include/WifiCredentials.h)

### MTAPI Server Issues

- **Invalid station data:** Check [`stations.json`](MTAPI/data/stations.json) formatting
- **Server crashes:** Inspect logs for Python errors, verify MTA API key is valid
- **No train updates:** Check MTA API status and CACHE_SECONDS setting

### Memory Issues

- **Heap fragmentation:** Enable heap debugging with `-DHEAPDEBUG` flag in [`platformio.ini`](platformio.ini)
- **JSON parsing errors:** Adjust document size in [`MTAManager.h`](include/MTAManager.h) (`DynamicJsonDocument doc{200 * 1024}`)

---

## Advanced Configuration

### LED Settings

Adjust LED brightness in [`LEDManager.cpp`](src/LEDManager.cpp):
```cpp
FastLED.setBrightness(5);  // Range: 0-255
```

### Subway Line Colors

Customize line colors in [`SubwayColors.cpp`](src/SubwayColors.cpp):
```cpp
routeColors = {
    {"1", Red},    {"2", Red},    {"3", Red},
    {"4", Green},  {"5", Green},  {"6", Green},
    // ... etc
};
```

### Network Parameters

Modify reconnection parameters in [`NetworkManager.cpp`](src/NetworkManager.cpp):
```cpp
const unsigned long maxBackoffMs = 30000;  // Maximum backoff time
```

### Train Arrival Window

Adjust the time window for train presence in [`Train.h`](include/Train.h):
```cpp
static const uint8_t arrivalWindowSeconds = 30;  // Time in seconds
```

### Debug Output

Enable debug logging by adding `-DDEBUG` to build flags in [`platformio.ini`](platformio.ini):
```ini
build_flags =
    -std=gnu++17
    -DARDUINO_ARCH_ESP32
    -DDEBUG        # Enable debug output
    -DHEAPDEBUG    # Enable heap monitoring
```

---

## Credits

- Modified [MTAPI](https://github.com/jonthornton/MTAPI) with added WebSocket support for real-time MTA data
- [FastLED](https://github.com/FastLED/FastLED) for LED control
- [ArduinoJson](https://arduinojson.org/) for JSON parsing
- [ArduinoWebsockets](https://github.com/gilmaimon/ArduinoWebsockets) for WebSocket communication
- MTA for providing real-time transit data via GTFS-RT feeds

---

## License

This project is licensed under the GNU General Public License v3.0 (GPL-3.0).  
See [LICENSE](LICENSE) for full terms.

---

_This project is not affiliated with or endorsed by the Metropolitan Transportation Authority (MTA)._
