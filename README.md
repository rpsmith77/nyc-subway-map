# NYC Subway Map LED Visualization

A real-time visualization of NYC subway train locations using an ESP32 microcontroller and WS2812B LED strips. This project creates a physical illuminated map that shows trains arriving at stations throughout the New York City subway system by lighting up LEDs at station locations when trains are present.

## Demo

[![Watch the video](https://img.youtube.com/vi/n46n9YuOSNA/maxresdefault.jpg)](https://youtube.com/shorts/n46n9YuOSNA)

---

## How It Works

The ESP32 connects to a custom [MTAPI server](MTAPI/README.md) via **WebSockets**. The server fetches real-time GTFS-RT data from the MTA, processes it, and broadcasts train arrival events. The ESP32 parses these JSON payloads and updates the LEDs to reflect train arrivals at each station, using line-specific colors.

- **WebSocket-based updates:**  
  The ESP32 maintains a persistent connection to `/ws` on the MTAPI server. Incoming messages are parsed and mapped to station LEDs in real time. This is more efficient and responsive than HTTP polling.

---

## Hardware Requirements

- ESP32 development board
- WS2812B LED strips (minimum 500 LEDs for full subway system)
- 5V power supply (≥10A recommended for full map)
- Wires and mounting materials
- Physical subway map for LED placement
- Optional: 2 additional LEDs for error/status indicators

---

## Software Dependencies

- [PlatformIO](https://platformio.org/) (recommended) or Arduino IDE
- Libraries:
  - [FastLED](.pio/libdeps/arduino_nano_esp32/FastLED/README.md)
  - [ArduinoJson](.pio/libdeps/arduino_nano_esp32/ArduinoJson/README.md)
  - [WiFi](https://github.com/espressif/arduino-esp32/tree/master/libraries/WiFi)
  - [ArduinoWebsockets](.pio/libdeps/arduino_nano_esp32/ArduinoWebsockets/README.md)
  - [Time](https://github.com/espressif/arduino-esp32/tree/master/libraries/Time)

---

## Project Structure

```
├── include/
│   ├── GeneratedStationMap.h   # Auto-generated LED-to-station mapping
│   ├── LEDManager.h            # LED control logic
│   ├── MTAManager.h            # MTA data handling
│   ├── NetworkManager.h        # WiFi/WebSocket management
│   ├── Station.h               # Station data structures
│   ├── SubwayColors.h          # Subway line color definitions
│   ├── TimeManager.h           # Time utilities
│   ├── Train.h                 # Train data structures
│   └── WifiCredentials.h       # WiFi/server credentials
├── src/
│   ├── main.cpp                # Main application logic
│   ├── LEDManager.cpp
│   ├── MTAManager.cpp
│   ├── NetworkManager.cpp
│   ├── Station.cpp
│   ├── SubwayColors.cpp
│   ├── TimeManager.cpp
│   ├── Train.cpp
├── MTAPI/                      # Python server for MTA data (WebSocket support)
│   ├── app.py
│   ├── requirements.txt
│   ├── settings.cfg.sample
│   └── data/
├── scripts/
│   └── generate_station_map.py # Generates station LED mapping header
├── test/                       # PlatformIO unit tests ([test/README](test/README))
├── platformio.ini              # PlatformIO configuration
└── README.md                   # This file
```

---

## Key Components

- [`main.cpp`](src/main.cpp): Main loop, WiFi/WebSocket setup, LED updates
- [`MTAManager.h`](include/MTAManager.h): Parses train arrival data, manages station/train state
- [`GeneratedStationMap.h`](include/GeneratedStationMap.h): Maps LED indices to station IDs (auto-generated by [`generate_station_map.py`](scripts/generate_station_map.py))
- [`WifiCredentials.h`](include/WifiCredentials.h): WiFi and server configuration
- [`LEDManager.h`](include/LEDManager.h): LED initialization and update logic
- [`SubwayColors.h`](include/SubwayColors.h): Subway line color mapping ([see implementation](src/SubwayColors.cpp))
- [`Train.h`](include/Train.h): Train arrival logic ([see implementation](src/Train.cpp))
- [`Station.h`](include/Station.h): Station and train data ([see implementation](src/Station.cpp))
- [`TimeManager.h`](include/TimeManager.h): NTP time setup and printing ([see implementation](src/TimeManager.cpp))
- [`NetworkManager.h`](include/NetworkManager.h): WiFi and WebSocket connection management ([see implementation](src/NetworkManager.cpp))
- [`MTAPI`](MTAPI/README.md): Python server for real-time MTA data

---

## Setup Instructions

### 1. Hardware Setup

1. Connect WS2812B LED data line to ESP32 pin 10 (D7)
2. Connect error/status LEDs to pin 5 (D2) (optional)
3. Power ESP32 and LED strips with a 5V supply
4. Mount LEDs on your map, matching each LED to its station

### 2. WiFi Configuration

Edit [`WifiCredentials.h`](include/WifiCredentials.h):

```cpp
#ifndef WIFI_CREDENTIALS_H
#define WIFI_CREDENTIALS_H
constexpr const char* WIFI_SSID = "your_wifi_ssid";
constexpr const char* WIFI_PASSWORD = "your_wifi_password";
constexpr const char* SERVER_HOST = "your_mtapi_server_ip";
constexpr const char* SERVER_PORT = "5000";
#endif // WIFI_CREDENTIALS_H
```

### 3. MTAPI Server Setup

This project uses a modified version of MTAPI that adds WebSocket support for real-time data broadcasting:

1.  The modified MTAPI is included in this project under the MTAPI directory
2.  Create a  `settings.cfg`  file based on  `settings.cfg.sample`:
```docker
       # MTA_KEY = 'your_mta_api_key' #deprecated
       STATIONS_FILE = 'data/stations.json'
       CACHE_SECONDS = 60
       MAX_TRAINS = 10
       MAX_MINUTES = 30
       THREADED = True
```
4.  Install Python dependencies:
```bash
    cd  MTAPI
    python3  -m  venv  .venv
    source  .venv/bin/activate
    pip  install  -r  requirements.txt
```
5.  Run the server:
    
    `python  app.py`
    
    Alternatively, use Docker:
    
    `docker-compose  up`
    

### 4. ESP32 Firmware Installation

**PlatformIO:**
1. Open project in PlatformIO
2. Build and upload to ESP32

**Arduino IDE:**
1. Install required libraries
2. Open `main.cpp` as sketch
3. Select ESP32 board
4. Upload

---

## Station Mapping

- [`GeneratedStationMap.h`](include/GeneratedStationMap.h) maps LED indices to MTA station IDs.
- Use [`generate_station_map.py`](scripts/generate_station_map.py) to regenerate the mapping if your LED layout changes.
- Ensure LED indices match the physical order of your installation.

---

## How the Code Works

### Real-Time Updates via WebSockets

- ESP32 connects to MTAPI server (`ws://<SERVER_HOST>:<SERVER_PORT>/ws`)
- Server pushes JSON train arrival data
- [`NetworkManager`](include/NetworkManager.h) handles connection and message parsing
- [`MTAManager`](include/MTAManager.h) updates station/train state and triggers LED updates
- [`LEDManager`](include/LEDManager.h) sets LED colors based on train arrivals and line colors

**Example connection logic:**
```cpp
wsClient.onMessage(OnWebSocketMessage);
String wsUrl = "ws://" + String(SERVER_HOST) + ":" + String(SERVER_PORT) + "/ws";
wsClient.connect(wsUrl);

void loop() {
  if (net.checkWifiConnection() && net.checkWebsocketConnection()) {
    net.poll();
  }
  MtaManager::purgeExpiredTrains();
  MtaManager::checkArrivals();
  LEDManager::show();
  EVERY_N_SECONDS(1) { digitalWrite(LED_BUILTIN, !digitalRead(LED_BUILTIN)); }
  EVERY_N_SECONDS(60) { TimeManager::printCurrentTime(); }
}
```

### Startup Sequence

- LEDs alternate even/odd with warm white until first train data arrives (system ready indicator).

### Error Handling

- White LED: WiFi connected
- Blinking red LED: WiFi connection issue
- Automatic reconnection with exponential backoff

---

## Troubleshooting

### LED Issues

- **No LEDs light up:** Check power and connections
- **Random flickering:** Power supply may be insufficient
- **Wrong stations light up:** Verify [`GeneratedStationMap.h`](include/GeneratedStationMap.h) matches your layout

### Connectivity Issues

- **Blinking red LED:** WiFi failed; check [`WifiCredentials.h`](include/WifiCredentials.h)
- **No data:** Ensure MTAPI server is running and accessible
- **Frequent reboots:** MTAPI server may be unreachable or erroring

### MTAPI Server Issues

- **Invalid station data:** Check `stations.json` formatting
- **Server crashes:** Inspect logs for Python errors, check memory

---

## Advanced Configuration

- Adjust LED brightness in [`LEDManager.cpp`](src/LEDManager.cpp) via `FastLED.setBrightness()`
- Change JSON document size in [`MTAManager.h`](include/MTAManager.h) (`doc{200 * 1024}`)
- Modify WebSocket reconnection parameters in [`NetworkManager.h`](include/NetworkManager.h)

---


## Credits

-   Modified MTAPI with added WebSocket support for interfacing with MTA data
-   FastLED  for LED control
-   ArduinoJson  for JSON parsing
-   ArduinoWebsockets  for WebSocket communication

## License

This project is licensed under the GNU General Public License v3.0 (GPL-3.0).  
See [LICENSE](LICENSE) for full terms.

---

_This project is not affiliated with or endorsed by the Metropolitan Transportation Authority (MTA)._
